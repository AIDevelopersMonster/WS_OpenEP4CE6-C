````markdown
# AT24CXX I2C EEPROM demo  
для платы **WS_OpenEP4CE6-C**

Демонстрационный проект работы с I2C-EEPROM семейства **AT24CXX**  
(24C02 / 04 / 08 / 16 и т.п.) на базе ПЛИС EP4CE6.

Модуль выполняет:
- запись 1 байта во встроенную EEPROM по фиксированному адресу;
- последующее чтение того же байта;
- вывод записанного и прочитанного значения на двухразрядный 7-сегментный индикатор в **HEX-формате**;
- в оригинальном китайском проекте дополнительно используется буззер и тест режима PIN_45 (0, F, 0, D, 0, B, 0, 7).

---

## 1. Описание работы

Используется модуль:

```verilog
module i2c(
    clk,
    rst,
    data_in,
    scl,
    sda,
    wr_input,
    rd_input,
    lowbit,
    en,
    seg_data,
    dgnd
);
````

Основная логика:

* **`data_in[3:0]`** – 4-битное значение, которое пользователь задаёт (например, переключателями/кнопками).
  Оно упаковывается в байт `writeData_reg` и записывается в EEPROM.
* **EEPROM-адрес**:

  * адрес устройства на шине I2C зашит как у стандартных AT24CXX (0xA0/0xA1, см. даташит);
  * адрес ячейки в памяти – фиксированный, `addr = 10` (0x0A).
* **Запись**:

  * по нажатию кнопки `wr_input` (активный низкий) модуль выполняет полную I2C-последовательность:
    START → адрес устройства → адрес ячейки → байт данных → STOP.
* **Чтение**:

  * по нажатию кнопки `rd_input` (активный низкий) выполняется:
    запись адреса ячейки → повторный START → чтение байта → STOP.
* **Индикация**:

  * двухразрядный 7-сегментный индикатор мультиплексируется сигналом `en[1:0]`;
  * на одном разряде показывается **записанное** значение (`writeData_reg`),
  * на другом – **прочитанное** (`readData_reg`);
  * декодер поддерживает HEX-цифры **0…F** (0–9,A,b,C,d,E,F).

---

## 2. Порты модуля

* `clk` – системный тактовый сигнал (обычно 50 МГц).
* `rst` – асинхронный сброс, **активный низкий**.
* `data_in[3:0]` – входные пользовательские данные (0…15).
* `wr_input` – вход кнопки **записи**, активный низкий (при нажатии = 0).
* `rd_input` – вход кнопки **чтения**, активный низкий.
* `scl` – линия I2C SCL (выход из ПЛИС).
* `sda` – линия I2C SDA (двунаправленная, open-drain, через подтяжку к VCC).
* `en[1:0]` – выбор разряда 7-сегментного индикатора.
* `seg_data[7:0]` – код сегментов (активный низкий, стандартная таблица 0…F).
* `lowbit` – младшая точка/доп. вывод индикатора (в демо просто постоянно 0).
* `dgnd[5:0]` – дополнительные «земли» других разрядов, притянуты к 0.

---

## 3. Внутренняя логика (кратко)

### Делитель частоты и фазы

* Регистр `clk_div` делит системный такт до более низкой частоты I2C.
* Сигналы `phase0…phase3` — 4 «подфазы» внутри одного периода SCL:

  * на них привязаны изменения SDA и моменты выборки ACK/данных;
  * на `phase0/phase2` формируется фронт/спад SCL.

### Машины состояний

Есть три уровня управления:

1. **`main_state` (2 бита)**

   * `00` – ожидание (idle);
   * `01` – цикл **записи** в EEPROM;
   * `10` – цикл **чтения** из EEPROM.

2. **`i2c_state` (3 бита)**

   * `ini`       – начальная отправка адреса устройства;
   * `sendaddr`  – отправка адреса ячейки `addr`;
   * `write_data`– отправка байта данных на запись;
   * `read_ini`  – повторный START и установка режима чтения;
   * `read_data` – поочерёдное чтение 8 бит с линии SDA.

3. **`inner_state` (4 бита)**

   * `start`   – формирование условия START;
   * `first…eighth` – последовательная отправка/приём 8 бит;
   * `ack`     – приём ACK/NACK;
   * `stop`    – формирование условия STOP.

---

## 4. Порядок работы с проектом

### 4.1. Подготовка

1. Собрать проект в Quartus (под целевую плату **WS_OpenEP4CE6-C**).

2. Убедиться, что на плате:

   * подключена микросхема **AT24CXX** к линиям `scl` и `sda`;
   * есть подтягивающие резисторы к VCC на обеих линиях I2C (обычно 4.7 кОм);
   * 7-сегментный индикатор и кнопки подключены согласно пинауту проекта.

3. Загрузить прошивку `.sof`/`.pof` в ПЛИС.

---

### 4.2. Типичный сценарий использования

1. **Сброс**

   * Нажмите и отпустите кнопку сброса, чтобы `rst` стал 0 → затем 1.
   * После сброса модуль переходит в состояние ожидания (`main_state = 00`).

2. **Задать данные для записи**

   * Установите на входе `data_in[3:0]` нужное значение.

     * Обычно это делается 4-битным DIP-переключателем или набором кнопок.
     * Диапазон: **0…15 (0x0…0xF)**.

3. **Записать байт в EEPROM**

   * Кратко нажмите кнопку, подключенную к `wr_input`
     (при нажатии на входе должен быть **0**, после отпускания – **1**).
   * Модуль:

     * срабатывает после внутренней задержки `cnt_delay` (нужна для паузы между операциями);
     * формирует последовательность I2C «запись»:
       START → адрес устройства → адрес ячейки `addr = 10` → байт данных → STOP.
   * На одном из разрядов индикатора (обычно левый) появится hex-цифра, соответствующая `data_in`.

4. **Прочитать байт из EEPROM**

   * Кратко нажмите кнопку, подключенную к `rd_input` (аналогично – активный низкий).
   * Модуль:

     * выполняет: запись адреса ячейки → повторный START в режиме чтения → чтение 8 бит → STOP;
     * складывает результат в `readData_reg`.
   * На другом разряде индикатора (обычно правый) появится hex-цифра, соответствующая прочитанному значению.

5. **Проверка**

   * Если всё работает правильно, оба разряда должны показывать **одну и ту же HEX-цифру**
     (с учётом того, что фактически используются только 4 младших бита).

---

### 4.3. Режим теста PIN_45 (из китайского проекта)

> *Опционально, если этот режим реализован в вашем верхнем модуле.*

* При притянутом к земле PIN_45 плата может входить в «режим теста индикатора»:

  * индикатор по очереди показывает `0F 0D 0B 07` и т.п.;
  * буззер работает прерывисто (сигнализируя о проходе тестовой программы).

В нашем модуле `i2c` за это напрямую не отвечает — режим теста реализуется обычно во внешнем верхнем модуле/обвязке.

---

## 5. Возможные доработки

Идеи, что можно улучшить и развить:

* Сделать адрес ячейки `addr` **программируемым** (вывод на DIP-переключатели/кнопки).
* Расширить `data_in` до 8 бит и отображать сразу два hex-разряда.
* Добавить **проверку ошибок** (например, мигание индикатора при отсутствии ACK).
* Интегрировать зуммер: короткий «пик» после успешной записи/чтения.
* Добавить отображение режима (например, «W»/«r» при записи/чтении).

---

## 6. Краткое резюме

* Модуль `i2c` демонстрирует полный цикл обмена с EEPROM AT24CXX по I2C.
* Управление максимально простое:
  **фиксированный адрес ячейки + 4-битные данные + две кнопки (Write/Read)**.
* Двухразрядный 7-сегментный индикатор наглядно показывает, что было записано и что прочитано.

Такой пример удобно использовать как базу для:

* изучения протокола I2C «вручную» (без IP-ядра контроллера),
* дальнейшего расширения – тесты памяти, логгеры, настройка параметров устройства и т.д.

```
